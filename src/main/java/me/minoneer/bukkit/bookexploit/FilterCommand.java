package me.minoneer.bukkit.bookexploit;

import net.md_5.bungee.api.ChatColor;
import org.bukkit.Material;
import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;
import org.jetbrains.annotations.NotNull;

public final class FilterCommand implements CommandExecutor {
    private final BookFilter bookFilter;

    public FilterCommand(@NotNull final BookFilter bookFilter) {
        this.bookFilter = bookFilter;
    }

    @Override
    public boolean onCommand(
            @NotNull CommandSender sender,
            @NotNull Command command,
            @NotNull String label,
            @NotNull String[] args
    ) {
        if (!command.getName().equalsIgnoreCase("filter") || !sender.hasPermission("bookfilter.filter")) {
            return false;
        }

        if (!(sender instanceof Player)) {
            sender.sendMessage(ChatColor.RED + "This command can only be used by a player!");
            return true;
        }

        final Player player = (Player) sender;
        final ItemStack book = player.getInventory().getItemInMainHand();

        if (book.getType() != Material.WRITTEN_BOOK && book.getType() != Material.WRITABLE_BOOK) {
            sender.sendMessage(ChatColor.RED + "You must hold a written book in your hand to filter");
            return true;
        }

        final ItemStack newBook = bookFilter.filterBook(book, player, FilterAction.COMMAND);
        if (newBook != null) {
            player.getInventory().addItem(newBook);
            sender.sendMessage(ChatColor.AQUA + "A filtered version of this book has been added to your inventory");
        } else {
            sender.sendMessage(ChatColor.AQUA + "This book does not contain any illegal click events");
        }
        return true;
    }
}
