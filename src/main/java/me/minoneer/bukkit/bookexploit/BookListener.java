package me.minoneer.bukkit.bookexploit;

import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.block.Action;
import org.bukkit.event.player.PlayerEditBookEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.EquipmentSlot;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.BookMeta;
import org.jetbrains.annotations.NotNull;

import java.util.logging.Level;
import java.util.logging.Logger;

public final class BookListener implements Listener {

    private final ConfigHandler config;
    private final BookFilter bookFilter;
    private final Logger logger;

    public BookListener(@NotNull ConfigHandler config, @NotNull BookFilter bookFilter, @NotNull Logger logger) {
        this.config = config;
        this.bookFilter = bookFilter;
        this.logger = logger;
    }

    @EventHandler(priority = EventPriority.LOW)
    public void onBookEdit(@NotNull final PlayerEditBookEvent event) {
        final Player player = event.getPlayer();
        if (!config.checkCreation()) {
            return;
        }

        final BookMeta filteredBookMeta = bookFilter.filterBookMeta(event.getNewBookMeta());
        if (filteredBookMeta != null) {
            logger.log(Level.WARNING, "Player {0} {1} tried to create a book with illegal click events!",
                    new Object[]{player.getName(), player.getUniqueId()});
            event.setNewBookMeta(filteredBookMeta);
            if (config.getPlayerMessage() != null) {
                player.sendMessage(config.getPlayerMessage());
            }
        }
    }

    @EventHandler(priority = EventPriority.LOW)
    public void onBookRead(@NotNull final PlayerInteractEvent event) {
        final Player player = event.getPlayer();
        if (!config.checkReading()) {
            return;
        }
        if (event.getAction() != Action.RIGHT_CLICK_AIR && event.getAction() != Action.RIGHT_CLICK_BLOCK) {
            return;
        }

        final ItemStack toFilter;
        if (event.getHand() == EquipmentSlot.OFF_HAND) {
            toFilter = player.getInventory().getItemInOffHand();
        } else {
            toFilter = player.getInventory().getItemInMainHand();
        }

        final ItemStack filtered = bookFilter.filterBook(toFilter);

        if (filtered != null) {
            logger.log(Level.WARNING, "Player {0} {1} tried to read a book with illegal click events!",
                    new Object[]{player.getName(), player.getUniqueId()});
            event.setCancelled(true);

            if (event.getHand() == EquipmentSlot.OFF_HAND) {
                player.getInventory().setItemInOffHand(filtered);
            } else {
                player.getInventory().setItemInMainHand(filtered);
            }
            player.updateInventory();

            if (config.getPlayerMessage() != null) {
                player.sendMessage(config.getPlayerMessage());
            }
        }
    }
}
