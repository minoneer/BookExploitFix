package me.minoneer.bukkit.bookexploit;

import org.bukkit.Bukkit;
import org.bukkit.plugin.java.JavaPlugin;
import org.jetbrains.annotations.Nullable;

import java.util.Objects;
import java.util.logging.Level;

public final class BookExploitFix extends JavaPlugin {

    @Override
    public void onDisable() {
        getLogger().log(Level.INFO, "{0} by minoneer deactivated", getDescription().getFullName());
    }

    @Override
    public void onEnable() {
        final ConfigHandler config = loadConfig();

        final BookFilter filter = new BookFilter(config.getFilterActions(), getLogger());

        registerCommands(filter);

        registerEvents(config, filter);

        enableProtocolLib(config, filter);

        getLogger().log(Level.INFO, "{0} by minoneer activated", getDescription().getFullName());
    }

    private ConfigHandler loadConfig() {
        return new ConfigHandler(this);
    }

    private void registerCommands(final BookFilter filter) {
        Objects.requireNonNull(getCommand("filter")).setExecutor(new FilterCommand(filter));
    }

    private void registerEvents(final ConfigHandler config, final BookFilter filter) {
        final BookListener listener = new BookListener(config, filter, getLogger());
        Bukkit.getPluginManager().registerEvents(listener, this);
    }

    private void enableProtocolLib(ConfigHandler config, BookFilter filter) {
        if (getServer().getPluginManager().isPluginEnabled("ProtocolLib")) {
            getLogger().info("Found ProtocolLib, enabling advanced protection features.");
            ProtocolLibHook.activate(this, filter, config, getLogger());
        } else {
            getLogger().warning("Missing ProtocolLib dependency, some protections are not available.");
        }
    }

    @Nullable
    public static String limitLoggingString(@Nullable final String input) {
        if (input == null) {
            return null;
        } else {
            return input.substring(0, Math.min(1500, input.length()));
        }
    }
}
